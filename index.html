<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Word Tap Picker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    #text-container {
      padding: 20px;
      font-size: 18px;
      line-height: 1.6;
    }
    #output {
      margin-top: 20px;
      font-size: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div id="text-container">
    <span>Click here to begin. </span>
    <span>यह एक परीक्षण वाक्य है। </span>
    <span>这是一个测试句子。 </span>
    <span>هذه جملة اختبار. </span>
  </div>

  <div id="output">Selected word: <span id="selected-word"></span></div>

  <script>
    const container = document.getElementById('text-container');

    function getWordInfoAtPoint(x, y) {
      const node = document.elementFromPoint(x, y);
      if (!node) return null;

      // Find deepest text node
      let textNode = null;
      const walker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, null);
      while (walker.nextNode()) {
        textNode = walker.currentNode;
        break;
      }

      if (!textNode) return null;

      const range = document.createRange();
      range.selectNodeContents(textNode);

      const text = textNode.textContent;
      if (!text || text.trim() === '') return null;

      const rects = [];
      for (let i = 0; i < text.length; i++) {
        range.setStart(textNode, i);
        range.setEnd(textNode, i + 1);
        const rect = range.getBoundingClientRect();
        rects.push({ index: i, rect });
      }

      const hit = rects.find(r =>
        x >= r.rect.left &&
        x <= r.rect.right &&
        y >= r.rect.top &&
        y <= r.rect.bottom
      );

      if (!hit) return null;

      const segmenter = new Intl.Segmenter('und', { granularity: 'word' });
      const segments = [...segmenter.segment(text)];

      for (const segment of segments) {
        const start = segment.index;
        const end = start + segment.segment.length;
        if (hit.index >= start && hit.index < end) {
          return {
            word: segment.segment,
            start,
            end,
            textNode
          };
        }
      }

      return null;
    }

    function handleTapOrClick(e) {
      const x = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
      const y = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
      if (x == null || y == null) return;

      const info = getWordInfoAtPoint(x, y);
      if (info) {
        document.getElementById('selected-word').textContent = info.word;
        console.log('Selected word:', info.word);

        // Visibly select the word
        const selection = window.getSelection();
        selection.removeAllRanges();
        const range = document.createRange();
        range.setStart(info.textNode, info.start);
        range.setEnd(info.textNode, info.end);
        selection.addRange(range);
      }
    }

    container.addEventListener('click', handleTapOrClick);
    container.addEventListener('touchend', handleTapOrClick);
  </script>

</body>
</html>
