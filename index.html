<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Selection on Click/Touch</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            line-height: 1.6;
            font-size: 18px;
        }
        
        #content {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        span {
            margin-right: 5px;
        }
        
        .highlight {
            background-color: yellow;
        }
        
        #selected-word-display {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            min-height: 20px;
        }
    </style>
</head>
<body>
    <h1>Click or Touch to Select Words</h1>
    <p>Click or tap on any word in the text below to select it. You can also drag to select multiple words as usual:</p>
    
    <div id="content">
        <span>This is some English text.</span>
        <span>Esto es texto en español.</span>
        <span>这是中文文本。</span>
        <span>これは日本語のテキストです。</span>
        <span>هذا نص باللغة العربية.</span>
    </div>
    
    <div id="selected-word-display">
        <strong>Selected word will appear here</strong>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('content');
            const wordDisplay = document.getElementById('selected-word-display');
            let isMouseDown = false;
            let hasDragged = false;
            let startX, startY;
            
            // For tracking drag operations
            container.addEventListener('mousedown', function(event) {
                // Only handle left clicks
                if (event.button !== 0) return;
                
                isMouseDown = true;
                hasDragged = false;
                startX = event.clientX;
                startY = event.clientY;
                
                // Don't prevent default - allows native drag selection to work
            });
            
            container.addEventListener('mousemove', function(event) {
                if (isMouseDown) {
                    // Check if the mouse has moved enough to be considered a drag
                    const deltaX = Math.abs(event.clientX - startX);
                    const deltaY = Math.abs(event.clientY - startY);
                    
                    if (deltaX > 3 || deltaY > 3) {
                        hasDragged = true;
                    }
                }
            });
            
            container.addEventListener('mouseup', function(event) {
                if (!isMouseDown) return;
                
                isMouseDown = false;
                
                // If user dragged, let the native selection handle it
                if (hasDragged) {
                    // Update display with the current selection
                    const selection = window.getSelection();
                    if (selection && selection.toString().trim() !== '') {
                        wordDisplay.innerHTML = `<strong>Selected:</strong> "${selection.toString()}"`;
                    }
                    return;
                }
                
                // If it was a simple click (no drag), select the word
                selectWordAtPoint(event.clientX, event.clientY);
            });
            
            // Mobile - touch event
            container.addEventListener('touchend', function(event) {
                // Check if it was a tap (no movement/scroll)
                if (event.changedTouches.length !== 1) return;
                
                const touch = event.changedTouches[0];
                selectWordAtPoint(touch.clientX, touch.clientY);
                
                // Prevent default only for taps on text
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                if (element && (element.closest('span') || 
                    (element.nodeType === Node.TEXT_NODE && element.parentNode.closest('span')))) {
                    event.preventDefault();
                }
            });
            
            // Common function to handle word selection
            function selectWordAtPoint(x, y) {
                // Get the element at position
                const element = document.elementFromPoint(x, y);
                if (!element) return false;
                
                // Check if we clicked/touched a span or its child text node
                const span = element.closest('span');
                if (!span || !span.textContent.trim()) return false;
                
                // Get the text node we're working with
                let textNode;
                if (element.nodeType === Node.TEXT_NODE) {
                    textNode = element;
                } else {
                    // Find the text node at the clicked position
                    const walker = document.createTreeWalker(
                        span,
                        NodeFilter.SHOW_TEXT,
                        null,
                        false
                    );
                    
                    while (walker.nextNode()) {
                        const node = walker.currentNode;
                        const range = document.createRange();
                        range.selectNodeContents(node);
                        const rect = range.getBoundingClientRect();
                        
                        if (x >= rect.left && x <= rect.right && 
                            y >= rect.top && y <= rect.bottom) {
                            textNode = node;
                            break;
                        }
                    }
                    
                    // If no text node found, use the first one as fallback
                    if (!textNode) {
                        const firstText = span.firstChild;
                        if (firstText && firstText.nodeType === Node.TEXT_NODE) {
                            textNode = firstText;
                        } else {
                            return false;
                        }
                    }
                }
                
                // Now we have the correct text node, get the offset within that node
                const offset = getTextNodeOffsetAtPoint(textNode, x, y);
                if (offset === -1) return false;
                
                const text = textNode.textContent;
                
                // Find word boundaries
                const startPos = findWordStart(text, offset);
                const endPos = findWordEnd(text, offset);
                
                // Create and apply the selection
                try {
                    const range = document.createRange();
                    range.setStart(textNode, startPos);
                    range.setEnd(textNode, endPos);
                    
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                    // Display the selected word
                    const selectedWord = text.substring(startPos, endPos);
                    wordDisplay.innerHTML = `<strong>Selected:</strong> "${selectedWord}"`;
                    
                    return true;
                } catch (e) {
                    console.error('Selection error:', e);
                    return false;
                }
            }
            
            // More accurate way to get text node offset at point
            function getTextNodeOffsetAtPoint(textNode, x, y) {
                const text = textNode.textContent;
                let lastOffset = -1;
                
                // For empty node
                if (!text || text.length === 0) return 0;
                
                // For short text, check character by character
                if (text.length < 50) {
                    for (let i = 0; i <= text.length; i++) {
                        const range = document.createRange();
                        range.setStart(textNode, 0);
                        range.setEnd(textNode, i);
                        
                        const rect = range.getBoundingClientRect();
                        if (x <= rect.right) {
                            // Determine if closer to this char or previous char
                            if (i > 0 && x < (rect.left + rect.right) / 2) {
                                return i - 1;
                            }
                            return i;
                        }
                        lastOffset = i;
                    }
                    return lastOffset;
                }
                
                // For longer text, use binary search
                let start = 0;
                let end = text.length;
                
                while (start <= end) {
                    const mid = Math.floor((start + end) / 2);
                    
                    const range = document.createRange();
                    range.setStart(textNode, 0);
                    range.setEnd(textNode, mid);
                    
                    const rect = range.getBoundingClientRect();
                    
                    if (x >= rect.left && x <= rect.right &&
                        y >= rect.top && y <= rect.bottom) {
                        // Need to find the specific character
                        for (let i = Math.max(0, mid - 5); i <= Math.min(text.length, mid + 5); i++) {
                            const charRange = document.createRange();
                            charRange.setStart(textNode, i);
                            charRange.setEnd(textNode, i + 1);
                            
                            const charRect = charRange.getBoundingClientRect();
                            if (x >= charRect.left && x <= charRect.right) {
                                return i;
                            }
                        }
                        return mid;
                    } else if (x < rect.left) {
                        end = mid - 1;
                    } else {
                        start = mid + 1;
                    }
                }
                
                // If point is beyond the end of the text
                if (x > getTextRightEdge(textNode)) {
                    return text.length;
                }
                
                return 0;
            }
            
            // Helper to get right edge of text node
            function getTextRightEdge(textNode) {
                const range = document.createRange();
                range.selectNodeContents(textNode);
                const rect = range.getBoundingClientRect();
                return rect.right;
            }
            
            // Find the start of a word
            function findWordStart(text, position) {
                if (position <= 0) return 0;
                
                let pos = position;
                
                // Move backward until we find a word boundary
                while (pos > 0 && !/\s/.test(text.charAt(pos - 1))) {
                    pos--;
                }
                
                return pos;
            }
            
            // Find the end of a word
            function findWordEnd(text, position) {
                if (position >= text.length) return text.length;
                
                let pos = position;
                
                // Move forward until we find a word boundary
                while (pos < text.length && !/\s/.test(text.charAt(pos))) {
                    pos++;
                }
                
                return pos;
            }
        });
    </script>
</body>
</html>
